# H2O Data Visualization and Calibration Tool

一个用于水分浓度数据可视化和校准的专业工具，支持Excel数据导入、实时图表生成、湿度传感器校准以及差值分析等功能。

## 📐 界面设计

### 🎨 现代化两栏布局
- **左栏**：数据输入和基本设置
  - 文件选择区域
  - 列选择功能
  - 时间设置选项
  
- **右栏**：高级功能和校准
  - 湿度校准参数
  - 校准配对设置
  - 差值分析功能

- **底部**：主要操作按钮
  - 图表生成
  - 数据导出

### 🖋️ 统一设计语言
- **字体统一**：全界面使用Arial字体，符合学术论文标准
- **字体层次**：组标题12pt、标签11pt、控件10pt、小控件9pt
- **间距合理**：10px标准间距，确保视觉舒适
- **按钮一致**：控件28px高度，主操作按钮36px
- **分组清晰**：使用GroupBox进行功能分组

## 功能特点

### 📊 数据可视化
- 支持Excel文件(.xlsx, .xls)导入
- **🆕 多文件数据组合**：可同时选择多个Excel文件，将不同文件的数据段按顺序组合成连续图表
- 多列数据同时绘制
- 时间序列数据处理
- 独立窗口图表显示
- 图表保存和复制功能

### 🔧 湿度传感器校准
- 基于压力校准的湿度数据修正
- 支持多组湿度-压力对配置（最多6组）
- 自动匹配列名功能
- 校准参数导入/导出
- 误差范围显示

### 📈 差值分析
- 30分钟时间点差值计算
- 多时间点差值分析(20/40/60分钟)
- 参考列设置和比较
- 结果导出功能

### 🎯 纵坐标标签多选
- **预设标签选项**：Water Concentration (ppm)、Temperature (°C)、Moisture Concentration (ppm)、Pressure (bar)
- **自定义标签**：支持用户输入任意纵坐标标签
- **智能切换**：根据选择自动显示/隐藏自定义输入框

### ⚙️ 其他功能
- 时间范围选择(全部/前2小时/自定义)
- 最近配置自动保存
- 批量数据导出
- 中文界面支持

## 安装和运行

### 方法一：使用启动脚本（推荐）
```bash
# 克隆或下载项目
cd masterthesis-data

# 运行启动脚本（会自动安装依赖）
./start.sh
```

### 方法二：手动安装
```bash
# 安装Python依赖
pip3 install PyQt5 matplotlib pandas numpy openpyxl

# 运行程序
python3 main.py
```

### 方法三：使用run.py
```bash
python3 run.py
```

## 使用方法

### 1. 加载数据文件
1. 点击"Select Excel File"按钮
2. 选择包含水分浓度和时间数据的Excel文件
3. 程序会自动识别列名并填充到选择列表中

### 2. 选择数据列
1. 在**左栏**的列选择区域中，使用Ctrl+点击选择多个要绘制的数据列
2. 在时间设置区域选择时间列
3. 可以点击"Auto-Match Pairs"按钮自动匹配湿度-压力对

### 3. 配置校准参数（可选）
1. 在**右栏**的校准设置区域中：
   - 勾选"Enable Moisture Calibration"启用校准
   - 设置校准参数 f1, f2, p_ref
   - 配置湿度-压力对（最多6组）
   - 设置误差范围

### 4. 设置时间范围
1. 选择显示模式：
   - "Show All Data"：显示全部数据
   - "First 2 Hours Only"：只显示前2小时
   - "Custom Range"：自定义时间范围

### 5. 差值分析（可选）
1. 在差值计算区域：
   - 勾选相应的差值计算选项
   - 设置参考列
   - 配置时间窗口

### 6. 设置纵坐标标签
1. 在**图表设置**区域：
   - 从下拉框选择预设标签（水浓度、温度、湿度浓度、压力）
   - 或选择"自定义"输入特定标签

### 7. 生成图表和导出
1. 点击**底部**的"Generate Chart"按钮生成图表
2. 点击"Export Data"按钮导出处理后的数据

## 🔥 多文件数据组合功能详细指南

### 🎯 功能概述
多文件数据组合功能允许您将来自不同Excel文件的数据段按时间顺序组合，生成连续的图表。这特别适用于：
- **温度加热过程**：不同阶段数据存储在不同文件中
- **长期实验**：数据分段记录需要整体分析
- **多设备数据**：来自不同设备的数据需要统一显示

### 📋 详细操作步骤

#### 步骤1：选择多文件模式
1. 在主界面**文件选择**区域
2. 点击 **"选择多个Excel文件组合"** 按钮（而不是"选择单个Excel文件"）
3. 系统会打开多文件配置对话框

#### 步骤2：选择Excel文件
1. 在多文件配置对话框中，点击 **"选择多个Excel文件"** 按钮
2. 在文件选择器中：
   - 按住 **Ctrl键** 同时点击多个Excel文件
   - 或者按住 **Shift键** 选择连续的多个文件
3. 点击"打开"确认选择
4. 系统会显示已选择的文件列表，格式如：
   ```
   0: 16.06.2025 20-90.xlsx
   1: 20.06.2025 90-290.xlsx
   2: 25.06.2025 290-500.xlsx
   3: 27.06.2025 500-550.xlsx
   ```

#### 步骤3：查看文件信息
在**文件信息**表格中，您可以看到：
- **文件名**：每个文件的名称
- **列数**：文件包含的列数
- **可用列**：显示前几个可用的列名

#### 步骤4：配置数据段
对于每个要组合的数据段：

1. **添加数据段**
   - 点击 **"添加数据段"** 按钮
   - 系统会添加一行配置项

2. **选择文件**
   - 在"文件"下拉框中选择要使用的文件
   - 显示格式：`0: 文件名.xlsx`

3. **选择数据列**
   - 在"列名"下拉框中选择要绘制的数据列
   - 系统会**自动识别温度相关列**（包含temperatur、temp、温度、°C等关键词）

4. **选择时间列**
   - 在"时间列"下拉框中选择时间列
   - 系统会**自动识别时间相关列**（包含zeit、time、datetime等关键词）

5. **设置时间范围**
   - **手动设置**：在"开始时间(h)"和"结束时间(h)"输入框中设置
   - **一键设置**：点击 **"全选时间"** 按钮自动设置为该文件的完整时间范围

#### 步骤5：配置示例（温度加热过程）
假设您有4个文件包含不同温度阶段的数据：

| 数据段 | 文件 | 列名 | 时间列 | 开始时间 | 结束时间 | 操作 |
|--------|------|------|---------|----------|----------|------|
| 1 | 0: 20-90.xlsx | Heizkreis 1 Temperatur | Datum/Zeit | 0.00 h | 25.00 h | 全选时间 |
| 2 | 1: 90-290.xlsx | Heizkreis 1 Temperatur | Datum/Zeit | 0.00 h | 2.00 h | 全选时间 |
| 3 | 2: 290-500.xlsx | Heizkreis 1 Temperatur | Datum/Zeit | 0.00 h | 2.00 h | 全选时间 |
| 4 | 3: 500-550.xlsx | Heizkreis 1 Temperatur | Datum/Zeit | 0.00 h | 2.00 h | 全选时间 |

#### 步骤6：预览和确认
1. 配置完所有数据段后，点击 **"预览组合结果"** 按钮
2. 系统会显示预览信息：
   ```
   组合成功！
   数据点总数: 1250
   时间范围: 0.00 - 31.00 小时
   数据段数: 4
   
   20-90.xlsx_Heizkreis 1 Temperatur: 500 个数据点
   90-290.xlsx_Heizkreis 1 Temperatur: 250 个数据点
   290-500.xlsx_Heizkreis 1 Temperatur: 250 个数据点
   500-550.xlsx_Heizkreis 1 Temperatur: 250 个数据点
   ```
3. 确认信息无误后，点击 **"确定"** 按钮

#### 步骤7：设置纵坐标并生成图表
1. 返回主界面，您会看到："已加载 4 个文件进行组合"
2. 在**图表设置**区域，选择合适的纵坐标标签（如"Temperature (°C)"）
3. 点击 **"Generate Chart"** 按钮
4. 系统会生成连续的组合图表，显示完整的温度加热过程

### 🎨 图表特点
组合后的图表具有以下特点：
- **时间连续性**：不同文件的数据在时间轴上连续显示
- **颜色区分**：不同数据段使用不同颜色标识
- **来源标识**：图例中显示数据来源（文件名_列名）
- **平滑过渡**：数据段之间自动调整时间偏移

### ⚠️ 注意事项
1. **文件格式**：确保所有Excel文件格式正确，包含有效数值数据
2. **时间列**：每个文件必须包含时间列，用于数据对齐
3. **数据单位**：确保不同文件中相同类型的数据使用相同单位
4. **数据质量**：检查数据中是否有异常值或缺失值
5. **内存限制**：处理大量文件时注意系统内存使用

### 🔧 故障排除
**问题：列选择下拉框为空**
- 确认文件已正确加载
- 检查Excel文件是否有有效的列标题
- 尝试重新选择文件

**问题：时间范围设置无效**
- 确认时间列包含有效的时间数据
- 检查时间格式是否标准
- 使用"全选时间"按钮自动设置

**问题：生成的图表不连续**
- 检查各文件的时间列格式是否一致
- 确认数据段配置顺序正确
- 验证时间范围设置是否合理

## 界面布局特点

### 🔍 左栏功能
- **数据输入**：专注于数据加载和基本选择
- **时间控制**：时间列选择和范围设置
- **直观操作**：清晰的按钮和列表界面

### ⚙️ 右栏功能  
- **高级设置**：校准参数和配对管理
- **专业工具**：差值分析和误差计算
- **参数管理**：导入导出功能

### 🎯 操作流程
1. **左栏** → 加载数据，选择列，设置时间
2. **右栏** → 配置校准，设置差值分析
3. **底部** → 生成图表，导出结果

## 技术特点

### 🏗️ 架构设计
- **模块化结构**：清晰的代码分层
- **PyQt5界面**：现代化GUI框架
- **数据处理**：pandas + numpy数据分析
- **图表绘制**：matplotlib专业绘图

### 📏 界面规范
- **响应式布局**：自适应窗口大小
- **字体规范**（学术论文标准）：
  - 组标题：Arial 12pt
  - 主要标签：Arial 11pt
  - 控件文字：Arial 10pt
  - 小控件：Arial 9pt
  - 主按钮：Arial 12pt Bold
- **图表字体**（符合论文要求）：
  - 坐标轴标签：11pt
  - 刻度标签：10pt
  - 图例文字：9pt
  - 基础字体：10pt
- **一致间距**：10px标准间距
- **分组管理**：GroupBox功能分组

### 🔧 校准算法
- 使用压力修正公式：`ppm_calibrated = concentration × (p_ref/p)^(f1·ln(p_ref/p)+f2)`
- 默认参数：f1=0.196798, f2=0.419073, p_ref=1.0
- 支持误差范围显示

## 系统要求

- **Python**: 3.7+
- **操作系统**: Windows / macOS / Linux  
- **依赖包**: PyQt5, matplotlib, pandas, numpy, openpyxl
- **内存**: 建议4GB+
- **屏幕**: 1200x800分辨率及以上

## 文件结构

```
masterthesis-data/
├── main.py                    # 主程序入口
├── run.py                     # 简化启动
├── start.sh                   # 自动安装脚本
├── README.md                  # 详细说明文档
├── QUICK_START.md             # 快速开始指南
├── requirements.txt           # 依赖列表
├── ui/                        # 用户界面模块
│   ├── main_window.py        # 主窗口（两栏布局）
│   ├── plot_widget.py        # 绘图组件
│   └── multi_file_dialog.py # 🆕 多文件配置对话框
├── data_processing/           # 数据处理模块
│   ├── data_loader.py        # 数据加载器
│   ├── multi_file_loader.py # 🆕 多文件数据加载器
│   └── time_analysis.py      # 时间分析
├── calibration/               # 校准功能模块
│   ├── calibration_core.py   # 校准核心算法
│   └── parameter_manager.py  # 参数管理
├── utils/                     # 工具模块
│   └── file_utils.py         # 文件工具
└── external_samples/          # 示例和测试文件
```

## 更新历史

### v2.1 - 多文件数据组合功能（最新）
- 🆕 **多文件数据组合**：支持选择多个Excel文件，将不同数据段按时间顺序组合
- 🎯 **纵坐标标签多选**：提供预设标签选项和自定义功能
- 🚀 **智能列识别**：自动识别温度、时间相关列
- ⚡ **一键时间设置**：全选时间按钮，自动设置文件完整时间范围
- 🔧 **用户体验优化**：删除确认、信号连接修复、界面布局改进

### v2.0 - 两栏布局设计
- 🎨 **界面重构**：采用现代化两栏布局
- 🖋️ **字体统一**：全界面Arial 10pt标准字体
- 📐 **间距优化**：10px标准间距，视觉更舒适
- 🔧 **功能分组**：左栏数据输入，右栏高级功能
- 📱 **响应式设计**：自适应窗口大小变化

### v1.0 - 基础功能版本
- 📊 数据可视化和图表生成
- 🔧 湿度传感器校准功能
- 📈 差值分析和导出功能
- 💾 参数保存和加载功能

## 🚀 快速开始示例

### 单文件数据分析
```bash
# 1. 启动程序
python3 main.py

# 2. 选择单个Excel文件
点击 "选择单个Excel文件" → 选择文件 → 选择数据列 → 生成图表
```

### 多文件数据组合（温度加热过程）
```bash
# 1. 启动程序并选择多文件模式
python3 main.py
点击 "选择多个Excel文件组合"

# 2. 选择所有温度阶段文件
选择文件：20-90.xlsx, 90-290.xlsx, 290-500.xlsx, 500-550.xlsx

# 3. 配置数据段
数据段1：20-90.xlsx → Temperatur列 → 全选时间
数据段2：90-290.xlsx → Temperatur列 → 全选时间  
数据段3：290-500.xlsx → Temperatur列 → 全选时间
数据段4：500-550.xlsx → Temperatur列 → 全选时间

# 4. 预览和生成
预览组合结果 → 确定 → 设置纵坐标为"Temperature (°C)" → 生成图表
```

### 纵坐标标签设置
```bash
# 在图表设置区域选择合适的标签：
1. Water Concentration (ppm) - 水浓度数据
2. Temperature (°C) - 温度数据  
3. Moisture Concentration (ppm) - 湿度浓度数据
4. Pressure (bar) - 压力数据
5. 自定义 - 输入任意标签
```

## 支持和反馈

### 获取帮助
- 📖 **详细文档**：参考 `MULTI_FILE_FEATURE_GUIDE.md`
- 🚀 **快速指南**：参考 `QUICK_START.md`
- 🆘 **故障排除**：检查控制台输出的调试信息

### 联系方式
如遇到问题或有改进建议，请创建Issue或提交Pull Request。

---

**开发团队**: H2O数据分析小组  
**版本**: v2.1 - 多文件数据组合功能  
**最后更新**: 2025年6月30日